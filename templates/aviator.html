{% extends 'base.html' %}

{% block title %}Aviator Game{% endblock %}

{% block extra_css %}
<style>
    .aviator-container {
        position: relative;
        background-color: #0f1923;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .game-screen {
        position: relative;
        background-color: #162331;
        border-radius: 10px;
        height: 400px;
        overflow: hidden;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .airplane {
        position: absolute;
        width: 80px;
        height: 80px;
        transition: all 0.1s linear;
        z-index: 10;
        display: none;
    }

    .airplane img {
        width: 100%;
        height: 100%;
        filter: brightness(1.2) contrast(1.2);
        transform: rotate(-15deg);
    }

    .multiplier-display {
        font-size: 3rem;
        font-weight: bold;
        color: #f1f1f1;
        text-align: center;
        z-index: 5;
    }

    .crash-text {
        position: absolute;
        font-size: 4rem;
        font-weight: bold;
        color: #ff4757;
        text-shadow: 0 0 10px rgba(255, 71, 87, 0.7);
        opacity: 0;
        z-index: 15;
    }

    .bet-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }

    .bet-input {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        background-color: #1e2a36;
        border: 1px solid #2c3e50;
        color: #f1f1f1;
    }

    .auto-cashout-container {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #162331;
        border-radius: 8px;
    }

    .game-buttons {
        display: flex;
        gap: 15px;
    }

    .btn-bet {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-place-bet {
        background-color: #2ecc71;
        color: white;
    }

    .btn-place-bet:hover {
        background-color: #27ae60;
        transform: translateY(-2px);
    }

    .btn-cashout {
        background-color: #3498db;
        color: white;
        display: none;
    }

    .btn-cashout:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
    }

    .btn-cashout:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
        transform: none;
    }

    .history-container {
        margin-top: 30px;
    }

    .history-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .history-item {
        padding: 8px 12px;
        border-radius: 15px;
        font-weight: bold;
    }

    .history-win {
        background-color: rgba(46, 204, 113, 0.2);
        color: #2ecc71;
        border: 1px solid #2ecc71;
    }

    .history-loss {
        background-color: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border: 1px solid #e74c3c;
    }

    .flight-path {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }
    
    .stats-container {
        background-color: #162331;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .stat-item {
        text-align: center;
        padding: 10px;
        background-color: #1e2a36;
        border-radius: 8px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #95a5a6;
    }
    
    .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #f1f1f1;
    }

    @media (max-width: 768px) {
        .game-buttons {
            flex-direction: column;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="text-center"><i class="fas fa-plane"></i> Aviator Game</h3>
                </div>
                <div class="card-body">
                    <div class="stats-container">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="user-balance">{{ current_user.wallet_balance }}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Last Win</div>
                                <div class="stat-value" id="last-win">0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="aviator-container">
                        <div class="game-screen">
                            <div class="airplane" id="airplane">
                                <img src="{{ url_for('static', filename='img/aviator-plane.png') }}" alt="Airplane">
                            </div>
                            <canvas class="flight-path" id="flight-path"></canvas>
                            <div class="multiplier-display" id="multiplier-display">1.00x</div>
                            <div class="crash-text" id="crash-text">CRASHED!</div>
                        </div>
                        
                        <div class="bet-controls">
                            <input type="number" class="bet-input" id="bet-amount" placeholder="Bet Amount" min="1" step="1">
                        </div>
                        
                        <div class="auto-cashout-container">
                            <input type="checkbox" id="auto-cashout-toggle">
                            <label for="auto-cashout-toggle" class="ms-2">Auto Cashout at</label>
                            <input type="number" class="bet-input ms-2" id="auto-cashout-value" placeholder="2.00" min="1.1" step="0.1" value="2.00" style="width: 100px;">
                            <span class="ms-1">x</span>
                        </div>
                        
                        <div class="game-buttons">
                            <button class="btn-bet btn-place-bet" id="place-bet-btn">PLACE BET</button>
                            <button class="btn-bet btn-cashout" id="cashout-btn" disabled>CASH OUT</button>
                        </div>
                    </div>
                    
                    <div class="history-container">
                        <h4>Game History</h4>
                        <div class="history-list" id="history-list">
                            <!-- Game history will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const airplane = document.getElementById('airplane');
        const multiplierDisplay = document.getElementById('multiplier-display');
        const crashText = document.getElementById('crash-text');
        const placeBetBtn = document.getElementById('place-bet-btn');
        const cashoutBtn = document.getElementById('cashout-btn');
        const betAmountInput = document.getElementById('bet-amount');
        const autoToggle = document.getElementById('auto-cashout-toggle');
        const autoCashoutValue = document.getElementById('auto-cashout-value');
        const historyList = document.getElementById('history-list');
        const userBalanceDisplay = document.getElementById('user-balance');
        const lastWinDisplay = document.getElementById('last-win');
        const canvas = document.getElementById('flight-path');
        const ctx = canvas.getContext('2d');
        
        // Set canvas dimensions
        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        let gameInterval;
        let currentMultiplier = 1.00;
        let gameActive = false;
        let gameData = null;
        let betAmount = 0;
        let autoCashoutMultiplier = 2.00;
        let cashoutDone = false;
        let flightPoints = [];
        
        // Get initial balance
        updateBalance();
        
        // Load game history
        loadGameHistory();
        
        // Event listeners
        placeBetBtn.addEventListener('click', placeBet);
        cashoutBtn.addEventListener('click', cashout);
        autoToggle.addEventListener('change', function() {
            autoCashoutValue.disabled = !this.checked;
        });
        
        autoCashoutValue.addEventListener('input', function() {
            autoCashoutMultiplier = parseFloat(this.value) || 2.00;
        });
        
        function updateBalance() {
            fetch('/get_wallet_balance')
                .then(response => response.json())
                .then(data => {
                    userBalanceDisplay.textContent = data.wallet_balance.toFixed(2);
                })
                .catch(error => console.error('Error fetching balance:', error));
        }
        
        function loadGameHistory() {
            fetch('/aviator/history')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        historyList.innerHTML = '';
                        data.history.forEach(game => {
                            const historyItem = document.createElement('div');
                            historyItem.className = `history-item ${game.result === 'win' ? 'history-win' : 'history-loss'}`;
                            historyItem.textContent = game.multiplier.toFixed(2) + 'x';
                            historyList.appendChild(historyItem);
                        });
                    }
                })
                .catch(error => console.error('Error loading history:', error));
        }
        
        function placeBet() {
            betAmount = parseFloat(betAmountInput.value);
            
            if (isNaN(betAmount) || betAmount <= 0) {
                alert('Please enter a valid bet amount');
                return;
            }
            
            autoCashoutMultiplier = parseFloat(autoCashoutValue.value) || 2.00;
            
            fetch('/aviator/place-bet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bet_amount: betAmount,
                    auto_cashout: autoToggle.checked ? autoCashoutMultiplier : null
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    gameData = data;
                    
                    // Update balance
                    userBalanceDisplay.textContent = data.new_balance.toFixed(2);
                    
                    // Start the game
                    startGame();
                } else {
                    alert(data.error || 'An error occurred');
                }
            })
            .catch(error => console.error('Error placing bet:', error));
        }
        
        function startGame() {
            // Reset game state
            currentMultiplier = 1.00;
            gameActive = true;
            cashoutDone = false;
            flightPoints = [{x: 50, y: canvas.height - 50}]; // Starting point
            
            // Show airplane and cashout button
            airplane.style.display = 'block';
            airplane.style.bottom = '50px';
            airplane.style.left = '50px';
            
            // Reset multiplier display
            multiplierDisplay.textContent = '1.00x';
            multiplierDisplay.style.color = '#f1f1f1';
            
            // Hide crash text
            crashText.style.opacity = '0';
            
            // Update UI
            placeBetBtn.disabled = true;
            betAmountInput.disabled = true;
            autoCashoutValue.disabled = true;
            autoToggle.disabled = true;
            cashoutBtn.style.display = 'block';
            cashoutBtn.disabled = false;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Start game loop
            gameInterval = setInterval(updateGame, 100);
        }
        
        function updateGame() {
            if (!gameActive) return;
            
            // Increase multiplier gradually
            currentMultiplier += 0.01;
            
            // Random factor for airplane movement
            const randomFactor = Math.random() * 0.3;
            
            // Update multiplier display
            multiplierDisplay.textContent = currentMultiplier.toFixed(2) + 'x';
            
            // Move airplane upward and to the right
            const newX = 50 + (currentMultiplier - 1) * 100;
            const newY = canvas.height - 50 - ((currentMultiplier - 1) * 50) - (randomFactor * 10);
            
            airplane.style.left = newX + 'px';
            airplane.style.bottom = (canvas.height - newY) + 'px';
            
            // Apply slight rotation based on current multiplier
            const rotationAngle = Math.min(30, 15 + (currentMultiplier - 1) * 5);
            airplane.style.transform = `rotate(${rotationAngle}deg) scale(${1 + (currentMultiplier - 1) * 0.05})`;
            
            // Add new point to flight path
            flightPoints.push({x: newX, y: newY});
            
            // Draw flight path
            drawFlightPath();
            
            // Check if auto cashout should trigger
            if (autoToggle.checked && currentMultiplier >= autoCashoutMultiplier && !cashoutDone) {
                cashout();
            }
            
            // Check if game should end (crash)
            if (currentMultiplier >= gameData.crash_point && !cashoutDone) {
                endGame(false);
            }
        }
        
        function drawFlightPath() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw line
            ctx.beginPath();
            ctx.moveTo(flightPoints[0].x, flightPoints[0].y);
            
            for (let i = 1; i < flightPoints.length; i++) {
                ctx.lineTo(flightPoints[i].x, flightPoints[i].y);
            }
            
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;
            ctx.stroke();
        }
        
        function cashout() {
            if (!gameActive || cashoutDone) return;
            
            cashoutDone = true;
            
            fetch('/aviator/cashout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    multiplier: currentMultiplier,
                    bet_id: gameData.bet_id
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    multiplierDisplay.style.color = '#2ecc71';
                    cashoutBtn.disabled = true;
                    
                    // Update balance
                    userBalanceDisplay.textContent = data.new_balance.toFixed(2);
                    lastWinDisplay.textContent = data.winnings.toFixed(2);
                    
                    // Continue showing flight until crash
                } else {
                    alert(data.error || 'An error occurred');
                }
            })
            .catch(error => console.error('Error cashing out:', error));
        }
        
        function endGame(cashoutSuccess) {
            gameActive = false;
            clearInterval(gameInterval);
            
            if (!cashoutSuccess && !cashoutDone) {
                // Show crash animation
                crashText.style.opacity = '1';
                crashText.style.animation = 'pulse 0.5s infinite alternate';
                airplane.style.transform = 'rotate(90deg) scale(0.8)';
                airplane.style.transition = 'all 0.5s ease-in';
                multiplierDisplay.style.color = '#ff4757';
                
                // Add smoke/explosion effect
                const explosion = document.createElement('div');
                explosion.style.position = 'absolute';
                explosion.style.left = airplane.style.left;
                explosion.style.bottom = airplane.style.bottom;
                explosion.style.width = '100px';
                explosion.style.height = '100px';
                explosion.style.borderRadius = '50%';
                explosion.style.background = 'radial-gradient(circle, rgba(255,71,87,0.8) 0%, rgba(255,71,87,0) 70%)';
                explosion.style.animation = 'explode 1s forwards';
                document.querySelector('.game-screen').appendChild(explosion);
                
                // Add CSS animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        100% { transform: scale(1.1); }
                    }
                    @keyframes explode {
                        0% { transform: scale(0); opacity: 1; }
                        100% { transform: scale(3); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
                
                // Call the crash API to update the game record
                fetch('/aviator/crash', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bet_id: gameData.bet_id,
                        crash_point: gameData.crash_point
                    }),
                })
                .catch(error => console.error('Error recording crash:', error));
            }
            
            // Add to history
            const historyItem = document.createElement('div');
            historyItem.className = `history-item ${cashoutDone ? 'history-win' : 'history-loss'}`;
            historyItem.textContent = currentMultiplier.toFixed(2) + 'x';
            historyList.prepend(historyItem);
            
            // Keep only the last 20 history items
            while (historyList.children.length > 20) {
                historyList.removeChild(historyList.lastChild);
            }
            
            // Reset UI after delay
            setTimeout(() => {
                placeBetBtn.disabled = false;
                betAmountInput.disabled = false;
                autoCashoutValue.disabled = !autoToggle.checked;
                autoToggle.disabled = false;
                cashoutBtn.style.display = 'none';
                crashText.style.opacity = '0';
                crashText.style.animation = 'none';
                airplane.style.display = 'none';
                airplane.style.transition = 'all 0.1s linear';
                
                // Remove any explosion effects
                const explosions = document.querySelectorAll('.game-screen > div:not(#airplane):not(.multiplier-display):not(.crash-text)');
                explosions.forEach(el => el.remove());
                
                // Reload game history
                loadGameHistory();
            }, 2000);
        }
    });
</script>
{% endblock %}
